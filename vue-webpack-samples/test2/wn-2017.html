<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <script type="text/javascript" src="https://niuaa.github.io/niua.github.io/zhl.js">
    </script>
</head>
<body>


<div>
    <h1 id="h1">xxx</h1>
    <h2 id="h2">fsfsdf</h2>
</div>


<canvas id="mouseEffectCanvans"/>

<style>
    #mouseEffectCanvans {
        position: absolute;
        z-index: 10;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        /*cursor: none;*/
    }
</style>


<script type="text/javascript">


    ;(function (window) {

        var ctx,
            hue,
            buffer,
            target = {
                x: 0,
                y: 0
            },
            tendrils = [],
            settings = {};

        settings.debug = true;
        settings.friction = 0.5;  // 收缩速度
        settings.trails = 20;  // 轨迹数量
        settings.size = 50;  // 轨迹长度
        settings.dampening = 0.25;  // 发散程度
        settings.tension = 0.98;

        Math.TWO_PI = Math.PI * 2;

        function Oscillator(options) {
            this.init(options || {});
        }

        Oscillator.prototype = (function () {

            var value = 0;

            return {

                init: function (options) {
                    this.phase = options.phase || 0;
                    this.offset = options.offset || 0;
                    this.frequency = options.frequency || 0.001;
                    this.amplitude = options.amplitude || 1;
                },

                update: function () {
                    this.phase += this.frequency;
                    value = this.offset + Math.sin(this.phase) * this.amplitude;
                    return value;
                },

                value: function () {
                    return value;
                }
            };

        })();

        function Tendril(options) {
            this.init(options || {});
        }

        Tendril.prototype = (function () {

            function Node() {
                this.x = 0;
                this.y = 0;
                this.vy = 0;
                this.vx = 0;
            }

            return {

                init: function (options) {

                    this.spring = options.spring + (Math.random() * 0.1) - 0.05;
                    this.friction = settings.friction + (Math.random() * 0.01) - 0.005;
                    this.nodes = [];

                    for (var i = 0, node; i < settings.size; i++) {

                        node = new Node();
                        node.x = target.x;
                        node.y = target.y;

                        this.nodes.push(node);
                    }
                },

                update: function () {

                    var spring = this.spring,
                        node = this.nodes[0];

                    node.vx += (target.x - node.x) * spring;
                    node.vy += (target.y - node.y) * spring;

                    /*if (target.x > 0 && node.x > 0) {
                        debugger
                    }
*/
                   //   node.vx += (0 - node.x) * spring;
                  //   node.vy += (0 - node.y) * spring;

                    for (var prev, i = 0, n = this.nodes.length; i < n; i++) {

                        node = this.nodes[i];

                        if (i > 0) {

                            prev = this.nodes[i - 1];

                            //console.log(node.vx, node.vy, this.friction)

                            //console.log(prev.x, node.x, prev.x - node.x)

                            node.vx += (prev.x - node.x) * spring;
                            node.vy += (prev.y - node.y) * spring;
                            node.vx += prev.vx * settings.dampening;
                            node.vy += prev.vy * settings.dampening;


                        }

                        node.vx *= this.friction;
                        node.vy *= this.friction;
                        node.x += node.vx;
                        node.y += node.vy;

                      /*  if (i == 0 && node.x > 0) {
                            console.log(node.x, node.y, node.vx, node.vy)
                        }*/


                        spring *= settings.tension;
                    }
                },

                draw: function () {

                    let x = this.nodes[0].x,
                        y = this.nodes[0].y,
                        a, b;

                    ctx.beginPath();
                    ctx.moveTo(x, y);

                    for (let i = 1, n = this.nodes.length - 2; i < n; i++) {

                        a = this.nodes[i];
                        b = this.nodes[i + 1];
                        x = (a.x + b.x) * 0.5;
                        y = (a.y + b.y) * 0.5;

                        ctx.quadraticCurveTo(a.x, a.y, x, y);
                    }


                   // a = this.nodes[i];
                //    b = this.nodes[i + 1];

                    a = this.nodes[this.nodes.length - 2];
                    b = this.nodes[this.nodes.length - 1];

                  //  console.log(a)

                    if (!this.timer) {
                        this.timer = setInterval(()=> {
                            console.log(x, y, a.x, a.y, b.x, b.y)
                        }, 1000);
                    }


                    //   ctx.quadraticCurveTo(a.x, a.y, b.x, b.y);
                    ctx.stroke();
                    ctx.closePath();
                }
            };

        })();


        function init(event) {

            document.removeEventListener('mousemove', init);
            document.removeEventListener('touchstart', init);

            document.addEventListener('mousemove', mousemove);
            document.addEventListener('touchmove', mousemove);
            document.addEventListener('touchstart', touchstart);

            //mousemove(event);
            reset();
            loop();
        }

        function reset() {

            tendrils = [];

            for (var i = 0; i < settings.trails; i++) {

                tendrils.push(new Tendril({
                    spring: 0.45 + 0.025 * (i / settings.trails)
                }));
            }
        }

        function loop() {

          //  if (!ctx.running) return;

            ctx.globalCompositeOperation = 'source-out';
            ctx.fillStyle = 'rgba(0,0,0,0)';
            ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            ctx.globalCompositeOperation = 'lighter';
            ctx.strokeStyle = 'hsla(' + Math.round(hue.update()) + ',90%,50%,0.25)';
            ctx.lineWidth = 1;

           /* if (ctx.frame % 60 == 0) {
                console.log(hue.update(), Math.round(hue.update()), hue.phase, hue.offset, hue.frequency, hue.amplitude);
            }*/

            for (var i = 0, tendril; i < settings.trails; i++) {
                tendril = tendrils[i];
                tendril.update();
                tendril.draw();
            }

           // ctx.frame++;
           // ctx.stats.update();
            requestAnimFrame(loop);
        }

        function resize() {
            ctx.canvas.width = window.innerWidth;
            ctx.canvas.height = window.innerHeight;
        }

        function start() {
            if (!ctx.running) {
                ctx.running = true;
                loop();
            }
        }

        function stop() {
            ctx.running = false;
        }

        function mousemove(event) {
            if (event.touches) {
                target.x = event.touches[0].pageX;
                target.y = event.touches[0].pageY;
            } else {
                target.x = event.clientX
                target.y = event.clientY;
            }
            event.preventDefault();
        }

        function touchstart(event) {
            if (event.touches.length == 1) {
                target.x = event.touches[0].pageX;
                target.y = event.touches[0].pageY;
            }
        }


        window.requestAnimFrame = (function () {
            return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || function (fn) {
                window.setTimeout(fn, 1000 / 60)
            };
        })();

        window.onload = function () {

            ctx = document.getElementById('mouseEffectCanvans').getContext('2d');
            ctx.stats = new Stats();
            ctx.running = true;
            ctx.frame = 1;


            hue = new Oscillator({
                phase: Math.random() * Math.TWO_PI,
                amplitude: 85,
                frequency: 0.0015,
                offset: 285
            });

            /*letters('h1');
            letters('h2');*/

            document.addEventListener('mousemove', init);
            document.addEventListener('touchstart', init);
           /* document.body.addEventListener('orientationchange', resize);
            window.addEventListener('resize', resize);
            window.addEventListener('focus', start);
            window.addEventListener('blur', stop);*/

            resize();

            /*if (window.DEBUG) {


            }*/

           /* var gui = new dat.GUI();

            settings.gui.add(settings, 'trails', 1, 30).onChange(reset);
            settings.gui.add(settings, 'size', 25, 75).onFinishChange(reset);
            settings.gui.add(settings, 'friction', 0.45, 0.55).onFinishChange(reset);
            settings.gui.add(settings, 'dampening', 0.01, 0.4).onFinishChange(reset);
            settings.gui.add(settings, 'tension', 0.95, 0.999).onFinishChange(reset);

            document.body.appendChild(ctx.stats.domElement);*/
        };

    })(window);

</script>
</body>
</html>
